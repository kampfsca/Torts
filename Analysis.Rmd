---
title: "Time Series"
author: "Andy Kampfschulte"
date: "December 18, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}

library(foreign)
library(tidyr)
library(dplyr)
library(wesanderson)

pal <- wes_palette("Zissou1", 52, "continuous")

df <- read.spss("Data/Dataset 1.1.sav", to.data.frame = TRUE)
df <- df[which(df$inclusion=="Yes"),]

base.info <- df[,-c(13:28,33:1231, 1235:1682)]
sub <- df[,-c(13:28,33:1231, 1235:1260, 1628:1682)]

colnames(sub)[87] <- "jan_07_17"


sub <- sub  %>%
  distinct(record_id, .keep_all = TRUE) %>% 
  pivot_longer(20:384) %>% 
  mutate(date = as.Date(name, "%b_%d_%y")) 


################## Getting Solar Elements ################

sun <- as.data.frame(table(sub$date))
sun <- sun[1:365,]
sun$Var1 <- as.Date(sun$Var1)
sun <- suncalc::getSunlightTimes(date = sun$Var1, 
                                               lat = 42.9634,
                                               lon = -85.670006,
                                               keep = c("sunrise","sunset"))
sun$daylength <- as.numeric(sun$sunset - sun$sunrise)

sun <- sun[,-c(2:3)]

sub <- left_join(sub, sun, by = "date")


rm(df)
```

>**Note:** There are apparently 8 repeat observations for record_id = 820

```{r}

sub <- sub %>% 
  group_by(record_id) %>% 
  mutate(zscore = (value - mean(value))/(sd(value)))

sub$wkend <- lubridate::wday(sub$date, week_start = 1)

sub$agecat <- ifelse(sub$age < median(sub$age), "<50pctl", ">=50pctl")
sub$bmicat <- ifelse(sub$bmi < median(sub$bmi), "<50pctl", ">=50pctl")

saveRDS(sub, "Data/analysis_raw_data.rds")
sub <- readRDS("Data/analysis_raw_data.rds")
library(ggplot2)
ggplot(sub, aes(x = date, y = zscore ,group = record_id, colour = wkend))+
  geom_line(alpha = .1, size = .1)+
  #facet_grid(NYHADichot~Comorbidity2orLess)+
  theme_bw()

```

```{r}

```

# Creating Lagged Effect 

```{r}
lag <- sub %>% 
  group_by(record_id) %>% 
  mutate(day = lubridate::day(date),
         week = lubridate::week(date),
         month = lubridate::month(date),
         n = 1,
         day2 = cumsum(n),
         dow = lubridate::wday(date),
         week.group = floor(1+(row_number()-1)/7)) %>% 
  select(-n) 

lag$week.2 <-ifelse(lag$week >= 44, lag$week - 43, lag$week+10)  

week.dat <- lag %>% 
  group_by(record_id, week.group) %>% 
  summarise(avg.wk = mean(value),
            std = sd(value),
            total = sum(value)) %>% 
  mutate(avg.total = mean(lag$value),
         diff = (avg.wk - avg.total))

week.dat <- week.dat %>% 
  group_by(record_id) %>% 
  mutate(zscore = (total - mean(total))/(sd(total)),
         mean.total.wk = mean(total))

ggplot(week.dat[which(week.dat$week.group != 53),],
       aes(x = week.group, y = zscore, group = record_id, fill = mean.total.wk))+
  geom_line(aes(colour = mean.total.wk),stat = "identity", alpha = 0.5, size =1, show.legend = FALSE)+
  #geom_hline(yintercept = 0, size = 1, colour = "gray60", alpha = .8)+
  #geom_vline(xintercept = c(11,24), size = 1.5, colour = pal[25], alpha = .8)+
  theme_bw()+
  scale_color_gradientn(colors = pal)+
  labs(x = "Week of Study",
       y = "Difference from Annual Average",
       title = "Fluxuations from Mean Activity by Week")



summaries <- lag %>% 
  group_by(record_id) %>% 
  summarise(mn = mean(value),
            sd = sd(value),
            freq = n())

lag.wk <- lag %>% 
  group_by(record_id, week) %>% 
  summarise(mn.wk = mean(value)) %>% 
  mutate(dff.wk = mn.wk - lag(mn.wk, n=1, default = NA)) %>% 
  left_join(., base.info, by = "record_id") %>% 
  left_join(., summaries, by = "record_id") %>% 
  mutate(std.value = (mn.wk - mn)/(sd))


ggplot(lag.wk, aes(x = week, y = std.value, group = record_id, colour = PADichot))+
  geom_line(aes(alpha = age), size = .8)+
  facet_grid(NYHADichot~Comorbidity2orLess)+
  scale_discrete_manual(values = pal[c(1,32)], aesthetics = "colour")+
  scale_alpha_continuous(range = c(.1,.8))+
  theme_bw()

```



# Dynamic Factor Analaysis Attempt 
## Modeling Broad Strokes - Creating series based on groups

```{r}
blah <- sub %>% 
  group_by(date,sex,NYHADichot,Comorbidity2orLess,Hospitalized) %>% 
  summarise(med = median(value),
            freq = n())
```

```{r}
library(tidyr)
library(dplyr)

sex <- sub %>% 
  group_by(date, sex) %>% 
  summarise(val = median(value)) %>% 
  pivot_wider(names_from = 2, values_from = 3)


nyha <- sub %>% 
  group_by(date, NYHADichot) %>% 
  summarise(val = median(value)) %>% 
  pivot_wider(names_from = 2, values_from = 3)

hosp <- sub %>% 
  group_by(date, Hospitalized) %>% 
  summarise(val = median(value)) %>% 
  pivot_wider(names_from = 2, values_from = 3)

cmbd <- sub %>% 
  group_by(date, Comorbidity2orLess) %>% 
  summarise(val = median(value)) %>% 
  pivot_wider(names_from = 2, values_from = 3)

pa <- sub %>% 
  group_by(date, PADichot) %>% 
  summarise(val = median(value)) %>% 
  pivot_wider(names_from = 2, values_from = 3)

age <- sub %>% 
  group_by(date, agecat) %>% 
  summarise(val = median(value)) %>% 
  pivot_wider(names_from = 2, values_from = 3)

bmi <- sub %>% 
  group_by(date, bmicat) %>% 
  summarise(val = median(value)) %>% 
  pivot_wider(names_from = 2, values_from = 3)

all.df <- cbind(sex, nyha, hosp, cmbd, pa, age, bmi)
all.df <- all.df[,-c(4,7,10,13,16,19)]


all.df <- t(as.matrix(all.df))
colnames(all.df) <- all.df[1,]

dat <- all.df[-1,]

dat <- apply(dat,2, as.numeric)

row.names(dat) <- c("Male", "Female", "Class I/II", "Class III/IV",
                    "Hosp. No", "Hosp. Yes", "Cmbds <=2", "Cmbds >2",
                    "PA<=132", "PA>132", "Age.young", "Age.old", "BMI.low", "BMI.high")
dat.z <- zscore(dat)


saveRDS(dat.z, "Data/analysis_data.rds")

N_ts <- dim(dat.z)[1]

library(reshape2)
dat.long <- melt(dat.z)
dat.long$wkend <- lubridate::wday(as.Date(dat.long$Var2, week_start = 1))
dat.long$wkend2 <- ifelse(dat.long$wkend %in% c(6,7), "Weekend", "Weekday")
dat.long$date <- as.Date(dat.long$Var2)


dat2 <- left_join(dat.long, sun, by = "date")

ggplot(data = dat2, aes(x = date, y = value))+
  geom_point(aes(colour = wkend2))+
  geom_line(alpha = .2)+
  #geom_point(aes(color = daylength),size = 2.90)+
  facet_grid(Var1~., labeller =  labeller(Var1 = c("Male", "Female", "Class I/II", "Class III/IV",
                    "Hosp. No", "Hosp. Yes", "Cmbds <=2", "Cmbds >2",
                    "PA<=132", "PA>132")))+
  scale_color_manual(values = p[c(1,4)], aesthetics = "color")+
  theme_bw()
```

```{r}

cntl.list = list(maxit=1500, trace=1, allow.degen = TRUE)
model.list.dne.2 = list(m=2, R="diagonal and unequal")
model.list.dne.3 = list(m=3, R="diagonal and unequal")
model.list.dne.4 = list(m=4, R="diagonal and unequal")
model.list.dne.5 = list(m=5, R="diagonal and unequal")
model.list.dne.6 = list(m=6, R="diagonal and unequal")

# model.list.de = list(m=2, R="diagonal and equal")
# model.list.unc = list(m=2, R="unconstrained")
# model.list.eqvarcov = list(m=2, R="equalvarcov")

kemz.dne.2 = MARSS(dat.z, model=model.list.dne.2,
    z.score=TRUE, form="dfa", control=cntl.list)
kemz.dne.3 = MARSS(dat.z, model=model.list.dne.3,
    z.score=TRUE, form="dfa", control=cntl.list)
kemz.dne.4 = MARSS(dat.z, model=model.list.dne.4,
    z.score=TRUE, form="dfa", control=cntl.list)
kemz.dne.5 = MARSS(dat.z, model=model.list.dne.5,
    z.score=TRUE, form="dfa", control=cntl.list)
kemz.dne.6 = MARSS(dat.z, model=model.list.dne.6,
    z.score=TRUE, form="dfa", control=cntl.list)


print(cbind(model=c("2", "3", "4", "5", "6"),
AICc=round(c(kemz.dne.2$AICc, kemz.dne.3$AICc, kemz.dne.4$AICc, kemz.dne.5$AICc,kemz.dne.6$AICc))),
quote=FALSE)

plot(kemz.dne.4)

```



## Model with Everything
```{r}
# Creating a Matrix with Time on the Row, and Each patient a given Column.
ids <- sub %>% 
  group_by(record_id) %>% 
  summarise(f = n()) %>% 
  sample_n(30) %>% 
  select(record_id)

dat <- sub[which(sub$record_id %in% ids$record_id),c(1,29,30)] %>% 
  pivot_wider(names_from = date, values_from = value) 

dat <- as.matrix(dat[,-1])
dat.z <- zscore(dat)

#dat_trans <- t(test_dat)

N_ts <- dim(dat.z)[1]

library(reshape2)
dat.long <- melt(dat.z)
dat.long$wkend <- lubridate::wday(as.Date(dat.long$Var2, week_start = 1))
dat.long$wkend2 <- ifelse(dat.long$wkend %in% c(6,7), "Weekend", "Weekday")
dat.long$date <- as.Date(dat.long$Var2)


dat2 <- left_join(dat.long, sun, by = "date")

ggplot(data = dat2, aes(x = date, y = value))+
  geom_line()+
  geom_point(aes(color = daylength),size = 2.90)+
  facet_grid(Var1~.)+
  scale_fill_gradientn(colors = pal, aesthetics = "color")+
  theme_bw()


###################################################
### code chunk number 21: Cs16_set_up_two_trends_echo UPDATED FOR DATA
###################################################

## Running DFA for m=3 states, exploring different variance/covariance structures
### The Unconstrained structure is not wanting to converge
#### There appeared to be a loarge outlier at the first observation for several series, I deleted
#### the observation in the above code when making the matrix, now there's convergence issues.

cntl.list = list(maxit=800, safe = TRUE, trace=1)
model.list.dne.1 = list(m=2, R="diagonal and unequal")
model.list.dne.2 = list(m=3, R="diagonal and unequal")
model.list.dne.3 = list(m=4, R="diagonal and unequal")
model.list.dne.4 = list(m=5, R="diagonal and unequal")
model.list.dne.5 = list(m=6, R="diagonal and unequal")

# model.list.de = list(m=2, R="diagonal and equal")
# model.list.unc = list(m=2, R="unconstrained")
# model.list.eqvarcov = list(m=2, R="equalvarcov")

kemz.dne.1 = MARSS(dat.z, model=list(m=4, R="diagonal and equal"),
    z.score=TRUE, form="dfa", control=cntl.list)
kemz.dne.2 = MARSS(dat.z, model=list(m=4, R="diagonal and unequal"),
    z.score=TRUE, form="dfa", control=cntl.list)
kemz.dne.3 = MARSS(dat.z, model=list(m=4, R="unconstrained"),
    z.score=TRUE, form="dfa", control=cntl.list)
kemz.dne.4 = MARSS(dat.z, model=list(m=4, R="equalvarcov"),
    z.score=TRUE, form="dfa", control=cntl.list)
#kemz.unc = MARSS(test_dat.z, model=model.list.unc,
    #z.score=TRUE, form="dfa", control=cntl.list)


print(cbind(model=c("de", "dne", "unc", "eqvcv"),
AICc=round(c(kemz.dne.1$AICc, kemz.dne.2$AICc, kemz.dne.3$AICc, kemz.dne.4$AICc))),
quote=FALSE)

plot(kemz.dne.2)
```

## Covariates 

```{r}
library(dplyr)
library(tidyr)
daylight <- sub[which(sub$record_id %in% ids$record_id),c(1,28,33)] %>% 
  pivot_wider(names_from = name, values_from = daylength) 
daylight <- as.matrix(daylight[1,-1])

day <- sub[which(sub$record_id %in% ids$record_id),c(1,28,35)] %>% 
  pivot_wider(names_from = name, values_from = wkend) 
day <- as.matrix(day[1,-1])

library(MARSS)


model.list.dne.2 = list(m=4, R="unconstrained", tinitx=1)
cntl.list <- list(minit=200, maxit=15000, allow.degen=FALSE)
marss = MARSS(dat.z, model=model.list.dne.2,
    z.score=TRUE, form="dfa", control=cntl.list)

marss.dl = MARSS(dat.z, model=model.list.dne.2,
    z.score=TRUE, form="dfa", control=cntl.list,
    covariates = rbind(daylight))
 
marss.day = MARSS(dat.z, model=model.list.dne.2,
    z.score=TRUE, form="dfa", control=cntl.list,
    covariates = rbind(day))

marss.dlday = MARSS(dat.z, model=model.list.dne.2,
    z.score=TRUE, form="dfa", control=cntl.list,
    covariates = rbind(day, daylight))

print(cbind(model = c("blank", "Daylight", "Day", "Daylight & Day"),
            AICc = round(c(marss$AICc, marss.dl$AICc, marss.day$AICc, marss.dlday$AICc))), 
      quote = FALSE)

plot(marss.dlday)

saveRDS(marss.dlday, file = "Modelling/MARSS_m4.rds")
dlday <- readRDS(marss.dlday, file = "Modelling/MARSS_m4.rds")

plot(dlday)
```


```{r}

# Rotations with diagonal and unequal structure
# big.maxit.cntl.list = list(minit=200, maxit=5000, allow.degen=FALSE)
# model.list = list(m=6, R="equalvarcov")
the.fit = mwdtp3


###################################################
### code chunk number 29: Cs21_varimax
###################################################
# get the inverse of the rotation matrix
Z.est = coef(the.fit, type="matrix")$Z

H.inv = 1
if(ncol(Z.est)>1) H.inv = varimax(coef(the.fit, type="matrix")$Z)$rotmat


###################################################
### code chunk number 30: Cs22_rotations
###################################################
# rotate factor loadings
Z.rot = Z.est %*% H.inv   
# rotate trends
trends.rot = solve(H.inv) %*% the.fit$states


###################################################
### code chunk number 31: Cs23_plotfacloadings
###################################################
#plot the factor loadings
N.ts <- dim(dat.z)[1]
spp = rownames(dat.z)
minZ = 0.005
m=dim(trends.rot)[1]
ylims = c(-1.1*max(abs(Z.rot)), 1.1*max(abs(Z.rot)))
par(mfrow=c(ceiling(m/2),2), mar=c(3,4,1.5,0.5), oma=c(0.4,1,1,1))
for(i in 1:m) {
	plot(c(1:N.ts)[abs(Z.rot[,i])>minZ], as.vector(Z.rot[abs(Z.rot[,i])>minZ,i]),
		type="h", lwd=2, xlab="", ylab="", xaxt="n", ylim=ylims, xlim=c(0,N.ts+1))
	for(j in 1:N.ts) {
		if(Z.rot[j,i] > minZ) {text(j, -0.05, spp[j], srt=90, adj=1, cex=0.9)}
		if(Z.rot[j,i] < -minZ) {text(j, 0.05, spp[j], srt=90, adj=0, cex=0.9)}
	abline(h=0, lwd=1, col="gray")
    } # end j loop
    mtext(paste("Factor loadings on trend",i,sep=" "),side=3,line=.5)
} # end i loop

```

```{r}
library(scales)
loads <- as.data.frame(Z.rot)
colnames(loads) <- c("State 1", "State 2", "State 3", "State 4")
loads$names <- row.names(dat)

loads <- pivot_longer(loads, cols = 1:4, names_to = "states")
ylim <- c(-.03, 0.10)

g1 <- ggplot(loads[loads$states=="State 1",], aes(x = reorder(names,-value), y = value))+
  geom_bar(stat = "identity")+
  theme_bw()+
  theme(plot.margin = margin(0,.2,.2,.2, "cm"),
        axis.text.x = element_text(size = 6, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 6),
        axis.title = element_blank())+
  scale_y_continuous(limits = ylim)

g2 <- ggplot(loads[loads$states=="State 2",], aes(x =reorder(names,-value), y = value))+
  geom_bar(stat = "identity")+
  theme_bw()+  
  theme(plot.margin = margin(.0,.2,.2,.2, "cm"),
        axis.text.x = element_text(size = 6, angle = 45, hjust = 1),
        axis.title = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())+
  scale_y_continuous(limits = ylim)

g3 <- ggplot(loads[loads$states=="State 3",], aes(x = reorder(names,-value), y = value))+
  geom_bar(stat = "identity")+
  theme_bw()+
    theme(plot.margin = margin(.0,.2,.2,.2, "cm"),
        axis.text.x = element_text(size = 6, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 6),
        axis.title = element_blank())+
  scale_y_continuous(limits = ylim)

g4 <- ggplot(loads[loads$states=="State 4",], aes(x = reorder(names,-value), y = value))+
  geom_bar(stat = "identity")+
  theme_bw()+
  theme(plot.margin = margin(.0,.2,.2,.2, "cm"),
        axis.text.x = element_text(size = 6, angle = 45, hjust = 1),
        axis.title = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())+
  scale_y_continuous(limits = ylim)

trendlines <- as.data.frame(t(trends.rot))
colnames(trendlines) <- c("State 1", "State 2", "State 3", "State 4")

ylim2 <- c(-35,12)
g1.1 <- ggplot(trendlines, aes(y = `State 1`, x = as.numeric(rownames(trendlines))))+
  geom_line(size = 1)+
  theme_bw()+
  scale_x_continuous(limits = c(0,365))+
  scale_y_continuous(limits = ylim2, position = "right")+
  theme(axis.title = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_text(size = 5),
        plot.margin = margin(.2,0,.1,.78, "cm"),
        panel.grid.minor.y = element_blank(),
        axis.ticks.x = element_blank(),
        plot.title = element_text(size = 10))+
  labs(title = "State 1")

g2.2 <- ggplot(trendlines, aes(y = `State 2`, x = as.numeric(rownames(trendlines))))+
  geom_line(size = 1)+
  theme_bw()+
  scale_x_continuous(limits = c(0,365), breaks = pretty_breaks(n = 8))+
  scale_y_continuous(limits = ylim2)+
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(.2,.2,.1,.5, "cm"),
        panel.grid.minor.x = element_blank(),
        axis.ticks.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        plot.title = element_text(size = 10))+
  labs(title = "State 2")


g3.3 <- ggplot(trendlines, aes(y = `State 3`, x = as.numeric(rownames(trendlines))))+
  geom_line(size = 1)+
  geom_hline(yintercept = 0, size = .5, alpha = .5, colour = "gray88")+
  theme_bw()+
  scale_x_continuous(limits = c(0,365))+
  scale_y_continuous(limits = ylim2, position = "right")+
  theme(axis.title = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_text(size = 5),
        plot.margin = margin(.2,0,.1,.78, "cm"),
        panel.grid.minor.y = element_blank(),
        axis.ticks.x = element_blank(),
        plot.title = element_text(size = 10))+
  labs(title = "State 3")

g4.4 <- ggplot(trendlines, aes(y = `State 4`, x = as.numeric(rownames(trendlines))))+
  geom_line(size = 1)+
  theme_bw()+
  scale_x_continuous(limits = c(0,365), breaks = pretty_breaks(n = 8))+
  scale_y_continuous(limits = ylim2)+
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        plot.margin = margin(.2,.2,.1,.5, "cm"),
        panel.grid.minor.x = element_blank(),
        axis.ticks.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        plot.title = element_text(size = 10))+
  labs(title = "State 4")

library(ggpubr)

ggarrange(ggarrange(g1.1, g1, ncol=1,nrow=2, heights = c(.4, 1)),
          ggarrange(g2.2, g2, ncol=1, nrow=2, heights = c(.4, 1)),
          ggarrange(g3.3, g3, ncol=1, nrow=2, heights = c(.4, 1)),
          ggarrange(g4.4, g4, ncol = 1, nrow =2, heights = c(.4, 1)),
          ncol = 2,
          nrow = 2)
ggsave("DFA_results.png")

```

## Visualizing Plot Trends

```{r DFA Fits and factor loadings}
###################################################
### code chunk number 32: Cs24_plottrends
###################################################
# get ts of trends
ts.trends = t(trends.rot)
par(mfrow=c(ceiling(dim(ts.trends)[2]/2),2), mar=c(3,4,1.5,0.5), oma=c(0.4,1,1,1))
# loop over each trend
for(i in 1:dim(ts.trends)[2]) {
	# set up plot area
	plot(ts.trends[,i],
		ylim=c(-1.1,1.1)*max(abs(ts.trends)), 
		type="n", lwd=2, bty="L", 
		xlab="", ylab="", xaxt="n", yaxt="n")
	# draw zero-line
	abline(h=0, col="gray")
	# plot trend line
	par(new=TRUE)
	plot(ts.trends[,i],
		ylim=c(-1.1,1.1)*max(abs(ts.trends)), 
		type="l", lwd=2, bty="L", 
		xlab="", ylab="", xaxt="n")
	# add panel labels
	mtext(paste("Trend",i,sep=" "), side=3, line=0.5)
	#axis(1,12*(0:dim(dat.spp.1980)[2])+1,1980+0:dim(dat.spp.1980)[2])
	} # end i loop (trends)


###################################################
### code chunk number 33: Cs25_func_get_DFA_fits
###################################################
getDFAfits <- function(MLEobj, alpha=0.05, covariates=NULL) {
  fits <- list()
  Ey <- MARSShatyt(MLEobj) # for var() calcs
  ZZ <- coef(MLEobj, type="matrix")$Z # estimated Z
  nn <- nrow(ZZ) # number of obs ts
  mm <- ncol(ZZ) # number of factors/states
  TT <- ncol(Ey$ytT)  # number of time steps
  ## check for covars
  if(!is.null(covariates)) {
    DD <- coef(MLEobj, type="matrix")$D
    cov_eff <- DD %*% covariates
  } else {
    cov_eff <- matrix(0, nn, TT)
  }
  ## model expectation
  fits$ex <- ZZ %*% MLEobj$states + cov_eff
  ## Var in model fits
  VtT <- MARSSkfss(MLEobj)$VtT
  VV <- NULL
  for(tt in 1:TT) {
    RZVZ <- coef(MLEobj, type="matrix")$R - ZZ%*%VtT[,,tt]%*%t(ZZ)
    SS <- Ey$yxtT[,,tt] - Ey$ytT[,tt,drop=FALSE] %*% t(MLEobj$states[,tt,drop=FALSE])
    VV <- cbind(VV,diag(RZVZ + SS%*%t(ZZ) + ZZ%*%t(SS)))
  }
  SE <- sqrt(VV)
  ## upper & lower (1-alpha)% CI
  fits$up <- qnorm(1-alpha/2)*SE + fits$ex
  fits$lo <- qnorm(alpha/2)*SE + fits$ex
  return(fits)
}


###################################################
### code chunk number 34: Cs25b_get_DFA_fits
###################################################
fit.b = getDFAfits(the.fit, alpha = 0.05, covariates = rbind(day,daylight))


###################################################
### code chunk number 35: Cs25c_plotbestfits
###################################################
# plot the fits
ylbl = rownames(dat.z)
w_ts = seq(dim(dat.z)[2])
par(mfcol=c(7,2), mar=c(1,4,1,1), oma=c(0.4,1,1,1))
for(i in 1:N.ts) {
  up <- fit.b$up[i,]
  mn <- fit.b$ex[i,]
  lo <- fit.b$lo[i,]
  plot(w_ts, mn, xlab="", ylab=ylbl[i], xaxt="n", type="n", cex.lab=1.2,
       ylim = c(min(lo),max(up)))
  #axis(1,12*(0:dim(dat.z)[2])+1,1980+0:dim(dat.z)[2])
  points(w_ts, dat.z[i,], pch=16, col="blue")
  lines(w_ts, up, col="darkgray")
  lines(w_ts, mn, col="black", lwd=2)
  lines(w_ts, lo, col="darkgray")
}

```


```{r Plots of Observed.Fitted}

###################################################
### code chunk number 36: Cs25d_plotwithaugment
###################################################
require(broom)
require(ggplot2)
library(dplyr)
library(tidyr)
library(wesanderson)
theme_set(theme_bw()) 
d <- augment(the.fit,type.predict = "observations",interval="confidence")
d.names <- data.frame(`.rownames` = unique(d$.rownames),
                      name = rownames(dat))
d <- left_join(d,d.names, by = ".rownames")

ggplot(data = d) + 
  #geom_line(aes(t, .fitted)) +
  #geom_line(aes(t, .resids), color = pal[50], alpha = .5)+
  geom_smooth(aes(t,y), stat = "smooth")+
  #geom_smooth(aes(t,.fitted), stat = "smooth", color = "red")+
  geom_point(aes(t, .fitted)) +
  geom_ribbon(aes(x=t, ymin=.conf.low, ymax=.conf.up), linetype=2, alpha=0.2) +
  facet_wrap( ~ name) +
  xlab("Time Step") + ylab("Count")

################################################################################
d2 <- pivot_longer(d, 3:4, names_to = "type")
pal <- wes_palette("Zissou1", 2, "continuous")
names.lab = c("Age > 69", "Age <= 69",
         "BMI > 30", "BMI <=30",
         "NYHA I/II", "NYHA III/IV",
         "2 or Less Comorbidities", "More than 2 Comorbidities",
         "Female", "Not Hospitalized", "Hospitalized",
         "Male", "P.A.<=132", "P.A.>132")
names(names.lab) <- sort(rownames(dat))

ggplot(d2, aes(t,value, color = type))+
  geom_smooth(stat = "smooth", method = "gam",formula = y ~ s(x, bs = "tp"), alpha = 0.1, size = .5)+
  geom_point(alpha = .25, size = .7)+
  facet_wrap(~name, labeller = labeller(name = names.lab))+
  scale_color_manual(values = pal, aesthetics = "color",
                     labels = c("Fitted", "Observed"))+
  theme(legend.position = c(.9,.1),
        strip.text = element_text(size = 6))+
  labs(color = "Fit Type", x = "Time (days)",
       y = "Activity (z-score)",
       title = "DFA Fitted Estimates vs. Observed Values")


ggsave("DFA_vs_Observed.png")


########################################################################################

library(gridExtra)

d2$var <- ifelse(d2$.rownames %in% c("Male", "Female"), "Gender",
                 ifelse(d2$.rownames %in% c("Class I/II", "Class III/IV"), "NYHA",
                        ifelse(d2$.rownames %in% c("Hosp. Yes", "Hosp. No"), "Hospitalization",
                               ifelse(d2$.rownames %in% c("Cmbds <=2", "Cmbds >2"), "Comorbidities",
                                      ifelse(d2$.rownames %in% c("PA<=132", "PA>132"), "Physical Activity",
                                             ifelse(d2$.rownames %in% c("Age.young", "Age.old"), "Age",
                                                    "BMI"))))))
d2$level <- ifelse(d2$name %in% c("Male", 
                                  "Class I/II", 
                                  "Hosp. No", 
                                  "Cmbds <=2", 
                                  "PA<=132", 
                                  "Age.young", 
                                  "BMI.low"), 
                   "first","second")

d2$type <- factor(d2$type,
                  levels = c(".fitted", "y"),
                  labels = c("Fitted", "Observed"))

pal <- wes_palette("Zissou1", 2, "continuous") ## Palette
leg.pos <- c(.35,.95) ## Legend Position
mars <- c(.5,.1,1.0,.1) ## Plot Margins
var.list <- list("Age", "BMI", "Comorbidities", "Gender", "Hospitalization", "NYHA", "Physical Activity") ## Variables

gg1 <- ggplot(d2[d2$var==var.list[1], ], aes(t,value, group = level, color = name))+
  geom_smooth(stat = "smooth", method = "gam",formula = y ~ s(x, bs = "tp"), alpha = 0.1, size = 1)+
  geom_point(alpha = .2, size = .4)+
  geom_line(size = .2, alpha = .2)+
  facet_grid(type~var)+
  scale_color_manual(values = pal, aesthetics = "color")+
  theme(strip.text = element_text(size = 10),
        strip.text.y = element_blank(),
        axis.text.x = element_text(size = 10),
        axis.title.x = element_blank(),
        legend.text = element_text(size = 6),
        legend.title = element_blank(),
        legend.background = element_rect(fill = "transparent"),
        legend.position = leg.pos,
        plot.margin = unit(mars, "cm"))+
  scale_y_continuous(limits = c(-3.5,3.5))+
  labs(x = "Time (days)",
       y = "Activity (z-score)",
       title = " ")

gg2 <- ggplot(d2[d2$var==var.list[2], ], aes(t,value, group = level, color = name))+
  geom_smooth(stat = "smooth", method = "gam",formula = y ~ s(x, bs = "tp"), alpha = 0.1, size = 1)+
  geom_point(alpha = .2, size = .4)+
  geom_line(size = .2, alpha = .2)+
  facet_grid(type~var)+
  scale_color_manual(values = pal, aesthetics = "color")+
  theme(strip.text = element_text(size = 10),
        strip.text.y = element_blank(),
        axis.text.x = element_text(size = 10),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title = element_blank(),
        legend.text = element_text(size = 6),
        legend.title = element_blank(),
        legend.background = element_rect(fill = "transparent"),
        legend.position = leg.pos,
        plot.margin = unit(mars, "cm"))+
  scale_y_continuous(limits = c(-3.5,3.5))+
  labs(color = "Fit Type", x = "Time (days)",
       y = "Activity (z-score)",
       title = " ")

gg3 <- ggplot(d2[d2$var==var.list[3], ], aes(t,value, group = level, color = name))+
  geom_smooth(stat = "smooth", method = "gam",formula = y ~ s(x, bs = "tp"), alpha = 0.1, size = 1)+
  geom_point(alpha = .2, size = .4)+
  geom_line(size = .2, alpha = .2)+
  facet_grid(type~var)+
  scale_color_manual(values = pal, aesthetics = "color")+
  theme(strip.text = element_text(size = 10),
        strip.text.y = element_blank(),
        axis.text.x = element_text(size = 10),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title = element_blank(),
        legend.text = element_text(size = 6),
        legend.title = element_blank(),
        legend.background = element_rect(fill = "transparent"),
        legend.position = leg.pos,
        plot.margin = unit(mars, "cm"))+
  scale_y_continuous(limits = c(-3.5,3.5))+
  labs(color = "Fit Type", x = "Time (days)",
       y = "Activity (z-score)",
       title = " ")

gg4 <- ggplot(d2[d2$var==var.list[4], ], aes(t,value, group = level, color = name))+
  geom_smooth(stat = "smooth", method = "gam",formula = y ~ s(x, bs = "tp"), alpha = 0.1, size = 1)+
  geom_point(alpha = .2, size = .4)+
  geom_line(size = .2, alpha = .2)+
  facet_grid(type~var)+
  scale_color_manual(values = pal, aesthetics = "color")+
  theme(strip.text = element_text(size = 10),
        strip.text.y = element_blank(),
        axis.text.x = element_text(size = 10),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank(),
        legend.text = element_text(size = 6),
        legend.title = element_blank(),
        legend.background = element_rect(fill = "transparent"),
        legend.position = leg.pos,
        plot.margin = unit(c(.5,.1,.5,.1), "cm"))+
  scale_y_continuous(limits = c(-3.5,3.5))+
  labs(color = "Fit Type", x = "Time (days)",
       y = "Activity (z-score)",
       title = "  ")

gg5 <- ggplot(d2[d2$var==var.list[5], ], aes(t,value, group = level, color = name))+
  geom_smooth(stat = "smooth", method = "gam",formula = y ~ s(x, bs = "tp"), alpha = 0.1, size = 1)+
  geom_point(alpha = .2, size = .4)+
  geom_line(size = .2, alpha = .2)+
  facet_grid(type~var)+
  scale_color_manual(values = pal, aesthetics = "color")+
  theme(strip.text = element_text(size = 10),
        strip.text.y = element_blank(),
        axis.text.x = element_text(size = 10),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title = element_blank(),
        legend.text = element_text(size = 6),
        legend.title = element_blank(),
        legend.background = element_rect(fill = "transparent"),
        legend.position = leg.pos,
        plot.margin = unit(mars, "cm"))+
  scale_y_continuous(limits = c(-3.5,3.5))+
  labs(color = "Fit Type", x = "Time (days)",
       y = "Activity (z-score)",
       title = " ")

gg6 <- ggplot(d2[d2$var==var.list[6], ], aes(t,value, group = level, color = name))+
  geom_smooth(stat = "smooth", method = "gam",formula = y ~ s(x, bs = "tp"), alpha = 0.1, size = 1)+
  geom_point(alpha = .2, size = .4)+
  geom_line(size = .2, alpha = .2)+
  facet_grid(type~var)+
  scale_color_manual(values = pal, aesthetics = "color")+
  theme(strip.text = element_text(size = 10),
        strip.text.y = element_blank(),
        axis.text.x = element_text(size = 10),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title = element_blank(),
        legend.text = element_text(size = 6),
        legend.title = element_blank(),
        legend.background = element_rect(fill = "transparent"),
        legend.position = leg.pos,
        plot.margin = unit(mars, "cm"))+
  scale_y_continuous(limits = c(-3.5,3.5))+
  labs(color = "Fit Type", x = "Time (days)",
       y = "Activity (z-score)",
       title = " ")

gg7 <- ggplot(d2[d2$var==var.list[7], ], aes(t,value, group = level, color = name))+
  geom_smooth(stat = "smooth", method = "gam",formula = y ~ s(x, bs = "tp"), alpha = 0.1, size = 1)+
  geom_point(alpha = .2, size = .4)+
  geom_line(size = .2, alpha = .2)+
  facet_grid(type~var)+
  scale_color_manual(values = pal, aesthetics = "color")+
  theme(strip.text = element_text(size = 10),
        axis.text.x = element_text(size = 10),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title = element_blank(),
        legend.text = element_text(size = 6),
        legend.title = element_blank(),
        legend.background = element_rect(fill = "transparent"),
        legend.position = leg.pos,
        plot.margin = unit(mars, "cm"))+
  scale_y_continuous(limits = c(-3.5,3.5))+
  labs(color = "Fit Type", x = "Time (days)",
       y = "Activity (z-score)",
       title = " ")

bam <- grid.arrange(gg1,gg2,gg3,gg4,gg5,gg6,gg7, ncol = 7,
             widths = c(.59,.5,.5,.5,.5,.5,.55))


ggsave("DFA_vs_Observed2.png", plot = bam, dpi = 1000)


################################################################################

d.state <- tidy(the.fit, type="states")

pal <- wes_palette("Zissou1", 4, "continuous")
ggplot(data = d.state) + 
  geom_line(aes(t, estimate, color = term), size = 2, alpha = .5) +
  geom_ribbon(aes(x=t, ymin=conf.low, ymax=conf.high, color = term), linetype=0, alpha=0.1)+
  scale_color_manual(values = pal, aesthetics = "color",
                     labels = c("State 1", "State 2", "State 3", "State 4"))+
  xlab("Time Step") + ylab("Count")+
  labs(title = "Underlying States", color = "Term")

ggsave("State_graph.png")
```


# Gettin at the seasonality trend...BRUH

```{r}
sub$day.z <- zscore(sub$daylength)

sub$z.diff <- sub$zscore/sub$daylength

pal <- wes_palette("Zissou1", 5, "continuous")
ggplot(data = sub, aes(x = date, y = z.diff))+
  geom_smooth(aes(x = date, y = z.diff, group = record_id, fill = Hospitalized), 
              stat = "smooth", alpha = .2, method = "gam", 
              formula = y ~ s(x, bs = "cs"))+
  geom_smooth(stat = "smooth", method = "gam", formula = y ~ s(x, bs = "cs"), color = pal[5])+
  geom_smooth(aes(x = date, y = zscore), stat = "smooth", method = "gam", formula = y ~ s(x, bs = "cs"), color = pal[3])+
  geom_line(aes(x = date, y = day.z))

```


```{r MARSS Model & Setup}

dat.diff <- t(dat)

dat.diff <- ts(dat.diff, start = 1, end = 365, frequency = 1)

acf(dat.diff)
pacf(dat.diff)


dat.diff <- diff(dat.diff, lag=frequency(dat.diff), differences=1)  
plot(dat.diff[,8], type="l", main="Seasonally Differenced") 

dat.diff.z <- zscore(t(dat.diff))
colnames(dat.diff.z) <- colnames(dat.z)[2:365]
rownames(dat.diff.z) <- rownmaes(dat.z)


dat.long <- melt(dat.diff.z)
dat.long$wkend <- lubridate::wday(as.Date(dat.long$Var2, week_start = 1))
dat.long$wkend2 <- ifelse(dat.long$wkend %in% c(6,7), "Weekend", "Weekday")
dat.long$date <- as.Date(dat.long$Var2)


dat2 <- left_join(dat.long, sun, by = "date")

ggplot(data = dat2, aes(x = date, y = value))+
  geom_line()+
  geom_point(aes(color = daylength),size = 2.90)+
  facet_grid(Var1~., labeller =  labeller(Var1 = c("Male", "Female", "Class I/II", "Class III/IV",
                    "Hosp. No", "Hosp. Yes", "Cmbds <=2", "Cmbds >2",
                    "PA<=132", "PA>132")))+
  scale_fill_gradientn(colors = pal, aesthetics = "color")+
  theme_bw()

day.diff <- day[,-1]
daylight.diff <- daylight[,-1]


model.list.dne.2 = list(m=2, R="diagonal and unequal", tinitx=1)
cntl.list <- list(minit=200, maxit=1200, allow.degen=FALSE)

marss.dlday.diff = MARSS(dat.diff.z, model=model.list.dne.2,
    z.score=TRUE, form="dfa", control=cntl.list,
    covariates = rbind(day.diff, daylight.diff))

plot(marss.dlday.diff)
```
















































```{r}
###################################################
###################################################


###################################################
### code chunk number 25: Cs18_setupmanytrends_echo (eval = FALSE)
###################################################
# set new control params
cntl.list = list(minit=200, maxit=5000, allow.degen=FALSE)
# set up forms of R matrices
levels.R = c("diagonal and equal",
             "diagonal and unequal",
             "equalvarcov",
             "unconstrained")
model.data = data.frame()
# fit lots of models & store results
# NOTE: this will take a long time to run!
for(R in levels.R) {
    for(m in 1:(N.ts-1)) {
        dfa.model = list(A="zero", R=R, m=m)
        kemz = MARSS(dat.z, model=dfa.model, control=cntl.list,
            form="dfa", z.score=TRUE)
        model.data = rbind(model.data,
                           data.frame(R=R,
                                      m=m,
                                      logLik=kemz$logLik,
                                      K=kemz$num.params,
                                      AICc=kemz$AICc,
                                      stringsAsFactors=FALSE))
        assign(paste("kemz", m, R, sep="."), kemz)
        } # end m loop
    } # end R loop


###################################################
### code chunk number 26: Cs19_makemodeltable
###################################################
#you must run the code to do all the models for this section
if(exists("model.data")){
# calculate delta-AICc
model.data$delta.AICc = model.data$AICc - min(model.data$AICc)
# calculate Akaike weights
wt = exp(-0.5*model.data$delta.AICc)
model.data$Ak.wt = wt/sum(wt)
# sort results
model.tbl = model.data[order(model.data$AICc),-4]
# drop AICc from table
# calculate cumulative wts
model.tbl$Ak.wt.cum = cumsum(model.tbl$Ak.wt)
model.tbl = model.tbl[,-4]
}


###################################################
### code chunk number 28: Cs20_kem3_R_unconstrained
###################################################

# Rotations with diagonal and unequal structure
big.maxit.cntl.list = list(minit=200, maxit=5000, allow.degen=FALSE)
model.list = list(m=6, R="equalvarcov")
the.fit = MARSS(test_dat.z, model=model.list, form="dfa", control=big.maxit.cntl.list)


###################################################
### code chunk number 29: Cs21_varimax
###################################################
# get the inverse of the rotation matrix
Z.est = coef(the.fit, type="matrix")$Z
H.inv = 1
if(ncol(Z.est)>1) H.inv = varimax(coef(the.fit, type="matrix")$Z)$rotmat


###################################################
### code chunk number 30: Cs22_rotations
###################################################
# rotate factor loadings
Z.rot = Z.est %*% H.inv   
# rotate trends
trends.rot = solve(H.inv) %*% the.fit$states


###################################################
### code chunk number 31: Cs23_plotfacloadings
###################################################
#plot the factor loadings
N.ts <- dim(test_dat.z)[1]
spp = rownames(test_dat.z)
minZ = 0.05
m=dim(trends.rot)[1]
ylims = c(-1.1*max(abs(Z.rot)), 1.1*max(abs(Z.rot)))
par(mfrow=c(ceiling(m/2),2), mar=c(3,4,1.5,0.5), oma=c(0.4,1,1,1))
for(i in 1:m) {
	plot(c(1:N.ts)[abs(Z.rot[,i])>minZ], as.vector(Z.rot[abs(Z.rot[,i])>minZ,i]),
		type="h", lwd=2, xlab="", ylab="", xaxt="n", ylim=ylims, xlim=c(0,N.ts+1))
	for(j in 1:N.ts) {
		if(Z.rot[j,i] > minZ) {text(j, -0.05, spp[j], srt=90, adj=1, cex=0.9)}
		if(Z.rot[j,i] < -minZ) {text(j, 0.05, spp[j], srt=90, adj=0, cex=0.9)}
	abline(h=0, lwd=1, col="gray")
    } # end j loop
    mtext(paste("Factor loadings on trend",i,sep=" "),side=3,line=.5)
} # end i loop


###################################################
### code chunk number 32: Cs24_plottrends
###################################################
# get ts of trends
ts.trends = t(trends.rot)
par(mfrow=c(ceiling(dim(ts.trends)[2]/2),2), mar=c(3,4,1.5,0.5), oma=c(0.4,1,1,1))
# loop over each trend
for(i in 1:dim(ts.trends)[2]) {
	# set up plot area
	plot(ts.trends[,i],
		ylim=c(-1.1,1.1)*max(abs(ts.trends)), 
		type="n", lwd=2, bty="L", 
		xlab="", ylab="", xaxt="n", yaxt="n")
	# draw zero-line
	abline(h=0, col="gray")
	# plot trend line
	par(new=TRUE)
	plot(ts.trends[,i],
		ylim=c(-1.1,1.1)*max(abs(ts.trends)), 
		type="l", lwd=2, bty="L", 
		xlab="", ylab="", xaxt="n")
	# add panel labels
	mtext(paste("Trend",i,sep=" "), side=3, line=0.5)
	#axis(1,12*(0:dim(dat.spp.1980)[2])+1,1980+0:dim(dat.spp.1980)[2])
	} # end i loop (trends)


###################################################
### code chunk number 33: Cs25_func_get_DFA_fits
###################################################
getDFAfits <- function(MLEobj, alpha=0.05, covariates=NULL) {
  fits <- list()
  Ey <- MARSShatyt(MLEobj) # for var() calcs
  ZZ <- coef(MLEobj, type="matrix")$Z # estimated Z
  nn <- nrow(ZZ) # number of obs ts
  mm <- ncol(ZZ) # number of factors/states
  TT <- ncol(Ey$ytT)  # number of time steps
  ## check for covars
  if(!is.null(covariates)) {
    DD <- coef(MLEobj, type="matrix")$D
    cov_eff <- DD %*% covariates
  } else {
    cov_eff <- matrix(0, nn, TT)
  }
  ## model expectation
  fits$ex <- ZZ %*% MLEobj$states + cov_eff
  ## Var in model fits
  VtT <- MARSSkfss(MLEobj)$VtT
  VV <- NULL
  for(tt in 1:TT) {
    RZVZ <- coef(MLEobj, type="matrix")$R - ZZ%*%VtT[,,tt]%*%t(ZZ)
    SS <- Ey$yxtT[,,tt] - Ey$ytT[,tt,drop=FALSE] %*% t(MLEobj$states[,tt,drop=FALSE])
    VV <- cbind(VV,diag(RZVZ + SS%*%t(ZZ) + ZZ%*%t(SS)))
  }
  SE <- sqrt(VV)
  ## upper & lower (1-alpha)% CI
  fits$up <- qnorm(1-alpha/2)*SE + fits$ex
  fits$lo <- qnorm(alpha/2)*SE + fits$ex
  return(fits)
}


###################################################
### code chunk number 34: Cs25b_get_DFA_fits
###################################################
fit.b = getDFAfits(the.fit)


###################################################
### code chunk number 35: Cs25c_plotbestfits
###################################################
# plot the fits
ylbl = rownames(test_dat.z)
w_ts = seq(dim(test_dat.z)[2])
par(mfcol=c(3,2), mar=c(3,4,1.5,0.5), oma=c(0.4,1,1,1))
for(i in 1:N.ts) {
  up <- fit.b$up[i,]
  mn <- fit.b$ex[i,]
  lo <- fit.b$lo[i,]
  plot(w_ts, mn, xlab="", ylab=ylbl[i], xaxt="n", type="n", cex.lab=1.2,
       ylim = c(min(lo),max(up)))
  #axis(1,12*(0:dim(dat.z)[2])+1,1980+0:dim(dat.z)[2])
  points(w_ts, test_dat.z[i,], pch=16, col="blue")
  lines(w_ts, up, col="darkgray")
  lines(w_ts, mn, col="black", lwd=2)
  lines(w_ts, lo, col="darkgray")
}


###################################################
### code chunk number 36: Cs25d_plotwithaugment
###################################################
require(broom)
require(ggplot2)
theme_set(theme_bw()) 
d <- augment(the.fit, interval="confidence")
ggplot(data = d) + 
  geom_line(aes(t, .fitted)) +
  geom_point(aes(t, y)) +
  geom_ribbon(aes(x=t, ymin=.conf.low, ymax=.conf.up), linetype=2, alpha=0.2) +
  facet_grid(~.rownames) +
  xlab("Time Step") + ylab("Count")


```

## Covariate Matrices

```{r}
### Code to create Covariate matrices to place into the model

# Sex

sex <- sub[,c(1,28,7)] %>% 
  pivot_wider(names_from = name, values_from = sex) %>% 
  select(-record_id) %>% 
  as.matrix()

dat <- dat[,c(-1)] %>% 
  as.matrix()



```

- 06Jan2020
I'm beginning to think that the daily data is too granular, and making convergence difficult. Here I'll explore using the weekly aggregate of subject's daily acitivity.

```{r Weekly Aggregates}

dat <- week.dat[which(week.dat$week.group !=53),c(1,2,5)] %>% 
  pivot_wider(names_from = week.group, values_from = total) 
  
dat <- as.matrix(dat[,-1])

test_dat <- dat[1:100,]
test_dat.z <- zscore(test_dat)
#dat_trans <- t(test_dat)

N_ts <- dim(test_dat.z)[1]

spp <- seq(1,20,1)
clr <- seq(1,20,1)
cnt <- 1
par(mfrow=c(N_ts,1), mai=c(0.1,0.1,0.1,0.1), omi=c(0,0,0,0))
for(i in spp){
  plot(test_dat.z[i,],xlab="",ylab="Abundance index", bty="L", xaxt="n", pch=16, col=clr[cnt], type="b")
  cnt <- cnt + 1
}

###################################################
### code chunk number 21: Cs16_set_up_two_trends_echo UPDATED FOR DATA
###################################################

## Running DFA for m=3 states, exploring different variance/covariance structures
### The Unconstrained structure is not wanting to converge
#### There appeared to be a loarge outlier at the first observation for several series, I deleted
#### the observation in the above code when making the matrix, now there's convergence issues.

cntl.list = list(maxit=100, safe = TRUE)
model.list.dne.1 = list(m=1, R="diagonal and unequal")
model.list.dne.2 = list(m=2, R="diagonal and unequal")
model.list.dne.3 = list(m=3, R="diagonal and unequal")
model.list.dne.4 = list(m=4, R="diagonal and unequal")
model.list.dne.5 = list(m=5, R="diagonal and unequal")
# model.list.de = list(m=2, R="diagonal and equal")
# model.list.unc = list(m=2, R="unconstrained")
# model.list.eqvarcov = list(m=2, R="equalvarcov")

kemz.dne.1 = MARSS(test_dat.z, model=model.list.dne.1,
    z.score=TRUE, form="dfa", control=cntl.list)
kemz.dne.2 = MARSS(test_dat, model=model.list.dne.2,
    z.score=FALSE, form="dfa", control=cntl.list)
kemz.dne.3 = MARSS(test_dat.z, model=model.list.dne.3,
    z.score=TRUE, form="dfa", control=cntl.list)
kemz.dne.4 = MARSS(test_dat.z, model=model.list.dne.4,
    z.score=TRUE, form="dfa", control=cntl.list)
kemz.dne.5 = MARSS(test_dat.z, model=model.list.dne.5,
    z.score=TRUE, form="dfa", control=cntl.list)
# kemz.de = MARSS(test_dat.z, model=model.list.de,
#     z.score=TRUE, form="dfa", control=cntl.list)
# kemz.unc = MARSS(test_dat.z, model=model.list.unc,
#     z.score=TRUE, form="dfa", control=cntl.list)
# kemz.eqvarcov = MARSS(test_dat.z, model=model.list.eqvarcov,
#     z.score=TRUE, form="dfa", control=cntl.list)

print(cbind(model=c("1", "2", "3", "4", "5"),
AICc=round(c(kemz.dne.1$AICc,kemz.dne.2$AICc,kemz.dne.3$AICc,kemz.dne.4$AICc,kemz.dne.5$AICc))),
quote=FALSE)

plot(kemz.dne.5)
```

```{r}
###################################################
### code chunk number 25: Cs18_setupmanytrends_echo (eval = FALSE)
###################################################
# set new control params
cntl.list = list(minit=200, maxit=5000, allow.degen=FALSE)
# set up forms of R matrices
levels.R = c("diagonal and equal",
             "diagonal and unequal",
             "equalvarcov",
             "unconstrained")
model.data = data.frame()
# fit lots of models & store results
# NOTE: this will take a long time to run!
for(R in levels.R) {
    for(m in 1:10) {
        dfa.model = list(A="zero", R=R, m=m)
        kemz = MARSS(test_dat.z, model=dfa.model, control=cntl.list,
            form="dfa", z.score=TRUE)
        model.data = rbind(model.data,
                           data.frame(R=R,
                                      m=m,
                                      logLik=kemz$logLik,
                                      K=kemz$num.params,
                                      AICc=kemz$AICc,
                                      stringsAsFactors=FALSE))
        assign(paste("kemz", m, R, sep="."), kemz)
        } # end m loop
    } # end R loop

```


```{r Plankton Example}
## load the data (there are 3 datasets contained here)
data(lakeWAplankton, package="MARSS")
## we want lakeWAplanktonTrans, which has been transformed
## so the 0s are replaced with NAs and the data z-scored
all_dat <- lakeWAplanktonTrans
## use only the 10 years from 1980-1989
yr_frst <- 1980
yr_last <- 1989
plank_dat <- all_dat[all_dat[,"Year"]>=yr_frst & all_dat[,"Year"]<=yr_last,]
## create vector of phytoplankton group names
phytoplankton <- c("Cryptomonas", "Diatoms", "Greens",
                   "Unicells", "Other.algae")
## get only the phytoplankton
dat_1980 <- plank_dat[,phytoplankton]

#Next, we transpose the data matrix and calculate the number of time series and their length.

## transpose data so time goes across columns
dat_1980 <- t(dat_1980)


## get number of time series
N_ts <- dim(dat_1980)[1]


## get length of time series
TT <- dim(dat_1980)[2] 


#It will be easier to estimate the real parameters of interest if we de-mean the data, so let’s do that.


y_bar <- apply(dat_1980, 1, mean, na.rm=TRUE)
dat <- dat_1980 - y_bar
rownames(dat) <- rownames(dat_1980)


#################################################################
spp <- rownames(dat_1980)
clr <- c("brown","blue","darkgreen","darkred","purple")
cnt <- 1
par(mfrow=c(N_ts,1), mai=c(0.5,0.7,0.1,0.1), omi=c(0,0,0,0))
for(i in spp){
  plot(dat[i,],xlab="",ylab="Abundance index", bty="L", xaxt="n", pch=16, col=clr[cnt], type="b")
  axis(1,12*(0:dim(dat_1980)[2])+1,yr_frst+0:dim(dat_1980)[2])
  title(i)
  cnt <- cnt + 1
  }
```

```{r}

library(gam)
fit <- gam::gam(value ~ s(date) + NYHADichot + Comorbidity2orLess, data = sub, family = gaussian)
plot.Gam(fit)

summary(fit)

gam.
fit <- lm(value~ date, data = sub)
```
